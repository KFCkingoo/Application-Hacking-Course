## h2 Break & Unbreak
Tämä raportti on tehty keväällä Teron ja Larin 2026 Sovellusten hakkerointi ja haavoittuvuudet - ICI012AS3A-3003 kurssia varten.

### Environment
Debian 13 Trixie VM

Mozilla Firefox

Netti disabloitiin FFuF-työkalun aikana

### x)
#### A01:2021 – Broken Access Control
Pääsynhallinta soveltaa käytäntöjä siten, että käyttäjiltä estetään toimintoja heidän tarkoitettujen käyttöoikeuksien ulkopuolella.
Puutteet johtavat haavoittuvuuksiin.

Pääsynhallinta on tehokasta kun hyökkääjä ei voi muokata pääsynhallinnan tarkistusta tai metadataa kuten luotettavissa palvelinpuolenkoodeissa tai palvelittomissa API:ssa.

Toiminnalliset pääsynhallinnan yksiköt ja intergraatiotestit ovat kannattavia.

#### Find Hidden Web Directories - Fuzz URLs with ffuf
Fuff löytää web palvelimen salaiset hakemistot automaattisesti.

Fuffilla voi pörröttää (fuzzing) kaikkea muutakin tietoa kuten POST parametrit ja tunnisteet.

Testataan ilman nettiä estääkseen pakettivuotoja.

#### Access control vulnerabilities and privilege escalation
Puutteelliset pääsynhallinnat ovat yleisiä ja yleensä kriittisisesti haavoittuvaisia.

Pääsynhallinta on taipuvainen virheille ihmissuunnittelun myöntä.

#### Karvinen 2006: Report Writing
Raporting ohjeet

### a) Break into 010-staff-only
Ajettiin tehtävä ohjeiden mukaisesti ja avattiin se selaimella `http://127.0.0.1:5000`.

Yritetty saada salasana SQL injektiolla, mutta kysely sallii vain numeroita.

Avattiin Firefox Inspector ja etsittiing number input-kyselyä.

Vaihdettiin number tyyppi tyhjäksi ja kokeiltiin uutta arvoa value="`'OR 1=1--`"

Uusi arvo hyväksyttiin ja annettuun salasanaan tuli uusi tulos 'Your password is foo', mutta tämä ei ollut haettua tulosta.

Pyydetty tehtävä muistuttaa aikaisemmassa kurssissa tehtyä PortSwiggerin SQL Injection Labraharjoituksia, joten sieltä otettiin mallia UNION.

Jatkettiin samalla tavalla salasanan kalastamista ja käyttämällä sivuston antamaa vinkkiä `SELECT password FROM pins WHERE pin='0';`.

Kokeiltiin uusi syöttö value="`'UNION SELECT password FROM pins--`":
<img width="700" height="700" alt="VirtualBox_DebianVM_22_01_2026_22_07_58" src="https://github.com/user-attachments/assets/569ed997-c657-4979-a3d8-60e496c25d00" />

Tulostui haluttu salasana.

### b) Fix the 010-staff-only vulnerability from source code. 

Huomattiin edellisestä tehtävästä, että haavoittuvuuden voidaan hyödyntää SQL injektiolla.

Yritettiin korjata haavoittuvuus muuttamalla SQL kyselyä.

Haavoittuvuus johtu siitä, että koodi suoritti kyselyn suoraan käyttäjän annetulla syötyllä täten mahdollistaen SQL injektion.

Avattiin lähdekoodi ja todettiin, että tehtävän vinkit ja ratkaisut olivat tarpeen osaamiseeni tasoon.

Käytin tässä osiossa myös tekoälyä, jos olisi ollut myös muita ratkaisuja kiinnostuksen myötä.

SQL kyselyn haavoittuvuutta korjattiin vaihtamalla SQL koodin pin syöttöä `pin=:pin;`.

Lisättiin uusi muuttuja seuraavaan riviin `safepin = {'pin': pin}`.

Lisättiin res rivin execute() funktion sisään safepin muuttuja `execute(text(sql), safepin)`.

<img width="542" height="151" alt="VirtualBox_DebianVM_22_01_2026_23_50_24" src="https://github.com/user-attachments/assets/eb58654e-83ee-4d29-a13e-ea531c65f7da" />

Testattiin toimivuus ja haavoittuvuus:

<img width="700" height="700" alt="VirtualBox_DebianVM_23_01_2026_00_12_26" src="https://github.com/user-attachments/assets/ed9da676-2ddf-4b9f-8bee-07141c39fa7c" />

<img width="700" height="700" alt="VirtualBox_DebianVM_23_01_2026_00_15_05" src="https://github.com/user-attachments/assets/3211699f-533d-4133-b933-861e0f819701" />

Korjaus toimi ja vahvisti turvallisuutta SQL injektiota vastaan.



### c) Solve dirfuzt-1 Admin page. Version control related page.
Ffuf ei toiminut paketin asennuksen jälkeen, asennettiin ilman pakettia.

Ajettiin tehtävä selaimeen ja otettiin VM netti pois käytöstä.

Ajettiin FFuF-työkalu tehtävään `./ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ`:

<img width="641" height="629" alt="VirtualBox_DebianVM_23_01_2026_01_16_16" src="https://github.com/user-attachments/assets/faac57e3-f8f5-4652-9eb7-08e772bef8b4" />

Huomattiin lukuisia hakemistoja joten asetettiin filtteri koolla `./ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ -fs 154`:

<img width="700" height="700" alt="VirtualBox_DebianVM_23_01_2026_01_20_14" src="https://github.com/user-attachments/assets/2bfb9ba5-37c8-40a2-b264-a13a9c5847f4" />

Kuvassa näkyy filteröidyt sisällöt, jossa on testattu wp-admin sivua.

Testattiin versionhallintaan liittyvät sivut selaimessa `http://127.0.0.2:8000/.git/logs/`:

<img width="535" height="174" alt="VirtualBox_DebianVM_23_01_2026_01_25_26" src="https://github.com/user-attachments/assets/643631fb-73ad-4659-877f-f65b2da2ef5a" />

Tuloksena samanlainen sivu, mutta eri lippu. Toimii.

### d) Break into 020-your-eyes-only.
FFuF-työkalulla saatiin admin-console kun käytettiin koko filtteriä.

Kun se syötettiin URL-päätteeseen, se meni `http://127.0.0.1:5000/accounts/login/?next=/admin-console/` sivustolle.

Yritettiin oikaista sisäänkirjautuminen erilaisilla syötteillä kuten `admin-console'--` ja `administrator-console`.

Login ja Register sivuilla oli varmaan joku hyöty tehtävään joten loin uuden käyttäjän abc.

Kirjauduin sisälle käyttäjänä ja Admin dashboard vei tällä kertaa 403 sivulle, mutta URL-linkki oli erilainen kuin aikaisemmin.
My datassa oli myös eri URL. 

Päätin kokeilla admin-console sivua uudelleen.

<img width="1058" height="360" alt="VirtualBox_DebianVM_23_01_2026_02_13_58" src="https://github.com/user-attachments/assets/43f641f3-e508-4b5b-8ec8-d1d18611f510" />

Päästiin admin-console sivulle.

### e) Fix the 020-your-eyes-only vulnerability.
Edellisen tehtävän perusteella lähdekoodissa oli todennäköisesti käyttäjäoikeuksien kanssa virheitä.

Yritettiin etsiä lähdekoodi käyttäjäoikeuksiin. 

Katsottiin eri tiedostoja eri hakemistosta, mutta ei edetty minnekään.

Otettiin ratkaisun käyttöön ja sen olisi pitänyt löytää `hats` hakemistosta `views.py` ohjelmalla. Kyseinen ohjelma löytyy myös `accounts` hakemistosta, mutta se ei ole sama.

Viimeiseen riviin lisättiin `and self.request.user.is_staff`:

```
class AdminShowAllView(UserPassesTestMixin, TemplateView):
        template_name="hats/admin-show-all.html"

        def test_func(self):
                return self.request.user.is_authenticated and self.request.user.is_staff
```

Testattiin admin-console uudestaan ja saatiin 403 pääsy estetty:

<img width="563" height="182" alt="VirtualBox_DebianVM_23_01_2026_02_52_39" src="https://github.com/user-attachments/assets/58043f46-9ad6-4eea-8777-197e40c718db" />

Korjaus toimi ja pääsy estetty normaalikäyttäjälle.

### g) Solve Portswigger Academy's "Lab: SQL injection vulnerability in WHERE clause allowing retrieval of hidden data".
Opettajat ei kai tykkää F nappulasta joten hypättiin g) osioon :D

Tehty tunnilla. 
Valitaan kategoria, sitten URL-päätteeseen `'OR 1=1--`.

### h) PortSwigger "Lab: SQL injection vulnerability allowing login bypass"
Tehty tunnilla. 
Oikaistaan syötteellä `administrator'--` käyttäjälle ja salasanaksi käy kaikki paitsi tyhjä spacebar.


### Lähteet
Karvinen 2023. Find Hidden Web Directories - Fuzz URLs with ffuf. https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/

OWASP: OWASP Top 10: A01 Broken Access Control. https://owasp.org/Top10/2021/A01_2021-Broken_Access_Control/index.html

PortSwigger. Access control vulnerabilities and privilege escalation. https://portswigger.net/web-security/access-control

PortSwigger. SQL injection. https://portswigger.net/web-security/sql-injection

PortSwigger. SQL injection UNION attacks. https://portswigger.net/web-security/sql-injection/union-attacks
